const web = require("express");
const app = web.Router();
const path = require("path");
const fs = require("fs");
const log = require("../utils/logger.js");

app.use((req, res, next) => {
    if (req.path.includes('.env')) {
        let geekedip = req.headers['x-forwarded-for'] || req.connection.remoteAddress || req.socket.remoteAddress || req.connection.socket.remoteAddress;
        if (geekedip.includes('::ffff:')) {
            geekedip = geekedip.split('::ffff:')[1];
        }
        const logmsg = `[.env] Logged IP: ${geekedip}\n`;
        const logpath = path.join(__dirname, '..', 'logs', 'exploit.log');
        fs.appendFileSync(logpath, logmsg);
        log.exploit(`Someone tried to access the .env file, their attempt was blocked, their IP is: ${geekedip}!`);
        return res.status(403).send(`[ICE ANTI-EXPLOIT] Ice backend has detected that you tried to perform an exploit on the backend to get it's critical files, your IP address has been logged.`);
    }
    next();
});
module.exports = app;